<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Qu·∫£n L√Ω Kh√≥a H·ªçc</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            color: var(--dark-gray);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1, h2 { text-align: center; margin-bottom: 30px; color: var(--dark-gray); }

        /* --- FORM STYLING --- */
        #course-form-section {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
            scroll-margin-top: 20px;
        }
        #form-title { font-size: 1.5rem; margin-bottom: 25px; text-align: center; color: var(--primary-color); }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px 30px;
        }
        .form-group { grid-column: span 1; }
        .full-width { grid-column: span 2; }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
            outline: none;
        }
        textarea { resize: vertical; min-height: 80px; }

        .form-actions {
            grid-column: span 2;
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
        }
        .btn-submit { background-color: var(--primary-color); color: white; }
        .btn-submit:hover { background-color: #0056b3; }
        .btn-cancel { background-color: #6c757d; color: white; }
        .btn-cancel:hover { background-color: #5a6268; }


        /* --- LIST STYLING --- */
        .list-section {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
         .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .list-header h2 {
            margin: 0;
        }
        .course-item {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .course-header {
            background-color: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .course-header h3 { margin: 0; font-size: 1.2rem; color: var(--dark-gray); }

        .course-body { padding: 20px; }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            font-size: 14px;
        }
        .detail-item span {
            font-weight: 600;
            color: #495057;
        }
        .detail-item { color: #212529; }
        
        .course-actions {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-edit { background-color: var(--secondary-color); color: white; }
        .btn-edit:hover { background-color: #1e7e34; }
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-delete:hover { background-color: #b21f2d; }
        .btn-update-all { background-color: var(--warning-color); color: black;}
        .btn-update-all:hover { background-color: #e0a800; }
    </style>
</head>
<body>

<div class="container">
    <h1>Trang Qu·∫£n Tr·ªã Kh√≥a H·ªçc</h1>

    <section id="course-form-section">
        <h2 id="form-title">Th√™m Kh√≥a H·ªçc M·ªõi</h2>
        <form id="formAddCourse">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="inputTen">T√™n kh√≥a h·ªçc</label>
                    <input type="text" id="inputTen" required placeholder="VD: Luy·ªán thi c·∫•p t·ªëc DGNL" />
                </div>
                <div class="form-group full-width">
                    <label for="inputmo_ta">M√¥ t·∫£ kh√≥a h·ªçc</label>
                    <textarea id="inputmo_ta" required></textarea>
                </div>
                 <div class="form-group">
                    <label for="selectKhuVuc">Ph√¢n lo·∫°i</label>
                    <select id="selectKhuVuc" required></select>
                </div>
                 <div class="form-group">
                    <label for="inputHinh">Link h√¨nh ·∫£nh (URL)</label>
                    <input type="url" id="inputHinh" placeholder="https://example.com/image.jpg" />
                </div>
                
                <div class="form-group">
                    <label for="inputGiaGoc">Gi√° g·ªëc (ch∆∞a gi·∫£m)</label>
                    <input type="number" id="inputGiaGoc" min="0" placeholder="B·ªè tr·ªëng n·∫øu kh√¥ng gi·∫£m gi√°" />
                </div>
                <div class="form-group">
                    <label for="inputGia">Gi√° b√°n (sau khi gi·∫£m)</label>
                    <input type="number" id="inputGia" required min="0" placeholder="Nh·∫≠p 0 n·∫øu mi·ªÖn ph√≠" />
                </div>
                
                <div class="form-group full-width" id="linkdrive-group" style="display: none;">
                    <label for="inputLinkdrive">Link Drive (cho kh√≥a h·ªçc mi·ªÖn ph√≠/t√†i li·ªáu)</label>
                    <input type="url" id="inputLinkdrive" placeholder="D√°n link Google Drive ho·∫∑c link t·∫£i tr·ª±c ti·∫øp v√†o ƒë√¢y" />
                </div>
                <div class="form-group">
                    <label for="inputRating">ƒêi·ªÉm ƒë√°nh gi√°</label>
                    <input type="number" id="inputRating" step="0.1" min="0" max="5" placeholder="VD: 4.5" />
                </div>
                 <div class="form-group">
                    <label for="inputRatingCount">S·ªë l∆∞·ª£t ƒë√°nh gi√°</label>
                    <input type="number" id="inputRatingCount" min="0" />
                </div>
                 <div class="form-group">
                    <label for="inputLuotMua">S·ªë l∆∞·ª£t mua</label>
                    <input type="number" id="inputLuotMua" min="0" />
                </div>
                <div class="form-group">
                    <label for="inputBadge">Nh√£n ƒë·∫∑c bi·ªát</label>
                    <input type="text" id="inputBadge" placeholder="VD: B√°n ch·∫°y, M·ªõi nh·∫•t..." />
                </div>

                <div class="form-actions">
                    <button type="submit" id="btn-submit" class="btn btn-submit">Th√™m Kh√≥a H·ªçc</button>
                    <button type="button" id="btn-cancel-edit" class="btn btn-cancel" style="display: none;">H·ªßy S·ª≠a</button>
                </div>
            </div>
        </form>
    </section>

    <section class="list-section">
        <div class="list-header">
             <h2>C√°c Kh√≥a H·ªçc Hi·ªán C√≥</h2>
             <button id="btn-update-all" class="btn btn-update-all">C·∫≠p nh·∫≠t D·ªØ li·ªáu c≈©</button>
        </div>
        <div id="listKhoaHoc"></div>
    </section>
</div>

<script>
    // ======== PH·∫¶N B·∫¢O V·ªÜ M·∫¨T KH·∫®U ============
    const PASSWORD = "lamlam2802"; // üîê Thay ƒë·ªïi m·∫≠t kh·∫©u t·∫°i ƒë√¢y

    function checkPassword() {
        const storedPassword = sessionStorage.getItem('adminPassword');
        if (storedPassword === PASSWORD) return;

        const input = prompt("üîê Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p trang admin:");
        if (input === PASSWORD) {
            sessionStorage.setItem('adminPassword', input);
        } else {
            alert("‚ùå M·∫≠t kh·∫©u sai. Quay v·ªÅ trang ch·ªß.");
            window.location.href = "/";
        }
    }
    checkPassword();

    // ======== ADMIN FUNCTIONALITY =============
    const SUPABASE_URL = "https://sdixqzzpggcxrbtaqqtf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkaXhxenpwZ2djeHJidGFxcXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MDQ4OTMsImV4cCI6MjA2NDE4MDg5M30.5nP_A5N6Jb2fDDNmRVcLva_znbrQhErt-xcpmm5V6S8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const danhSachKhuVuc = ["Kh√≥a Combo", "Kh√≥a h·ªçc mi·ªÖn ph√≠", "T√†i li·ªáu", "To√°n", "L√Ω", "H√≥a", "Ti·∫øng Anh", "Sinh", "VƒÉn", "S·ª≠", "ƒê·ªãa", "DGNL (HSA)", "VATC - APT", "DGTD (TSA)", "TOEIC", "IELTS", "ƒê·∫°i h·ªçc"];
    
    // DOM Elements
    const form = document.getElementById("formAddCourse");
    const listKhoaHocDiv = document.getElementById("listKhoaHoc");
    const formTitle = document.getElementById("form-title");
    const submitBtn = document.getElementById("btn-submit");
    const cancelBtn = document.getElementById("btn-cancel-edit");
    const updateAllBtn = document.getElementById("btn-update-all");
    
    // ‚ú® M√É M·ªöI: L·∫•y c√°c element m·ªõi ƒë·ªÉ x·ª≠ l√Ω ·∫©n/hi·ªán
    const selectKhuVuc = document.getElementById("selectKhuVuc");
    const giaInput = document.getElementById("inputGia");
    const linkdriveGroup = document.getElementById("linkdrive-group");
    
    let currentEditId = null; 

    // ‚ú® M√É M·ªöI: H√†m ki·ªÉm tra v√† ·∫©n/hi·ªán √¥ linkdrive
    function toggleLinkdriveVisibility() {
        const selectedValue = selectKhuVuc.value;
        const currentPrice = giaInput.value;
        if (selectedValue === 'Kh√≥a h·ªçc mi·ªÖn ph√≠' || selectedValue === 'T√†i li·ªáu' || currentPrice === '0') {
            linkdriveGroup.style.display = 'block';
        } else {
            linkdriveGroup.style.display = 'none';
        }
    }
    
    // ‚ú® M√É M·ªöI: Th√™m s·ª± ki·ªán ƒë·ªÉ t·ª± ƒë·ªông ·∫©n/hi·ªán
    selectKhuVuc.addEventListener('change', toggleLinkdriveVisibility);
    giaInput.addEventListener('input', toggleLinkdriveVisibility);

    function taoOptionKhuVuc() {
        // const select = document.getElementById("selectKhuVuc"); - ƒë√£ khai b√°o ·ªü tr√™n
        selectKhuVuc.innerHTML = '';
        danhSachKhuVuc.forEach(kv => {
            const option = document.createElement("option");
            option.value = kv;
            option.textContent = kv;
            selectKhuVuc.appendChild(option);
        });
    }
    
    async function hienThiDanhSachKhoaHoc() {
        const { data, error } = await supabase.from("khoahoc").select("*").order('loai').order('ten');
        if (error) {
            alert("‚ùå L·ªói t·∫£i kh√≥a h·ªçc: " + error.message);
            return;
        }

        listKhoaHocDiv.innerHTML = "";
        if (data.length === 0) {
            listKhoaHocDiv.innerHTML = `<p>Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>`;
            return;
        }

        data.forEach(kh => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "course-item";
            // Hi·ªÉn th·ªã th√™m linkdrive n·∫øu c√≥
            const linkdriveHTML = kh.linkdrive ? `<div class="detail-item" style="grid-column: span 2;"><span>Link Drive:</span> ${kh.linkdrive}</div>` : '';

            itemDiv.innerHTML = `
                <div class="course-header"><h3>${kh.ten}</h3></div>
                <div class="course-body">
                    <div class="details-grid">
                        <div class="detail-item"><span>Ph√¢n lo·∫°i:</span> ${kh.loai}</div>
                        <div class="detail-item"><span>Gi√° b√°n:</span> ${kh.gia?.toLocaleString('vi-VN')}ƒë</div>
                        <div class="detail-item"><span>Gi√° g·ªëc:</span> ${kh.gia_goc ? kh.gia_goc.toLocaleString('vi-VN') + 'ƒë' : 'N/A'}</div>
                        <div class="detail-item"><span>Rating:</span> ${kh.rating || 'N/A'} (${kh.rating_count || 0} reviews)</div>
                        <div class="detail-item"><span>L∆∞·ª£t mua:</span> ${kh.luot_mua || 0}</div>
                        <div class="detail-item"><span>Badge:</span> ${kh.badge || 'N/A'}</div>
                        <div class="detail-item" style="grid-column: span 2;"><span>M√¥ t·∫£:</span> ${kh.mo_ta}</div>
                        ${linkdriveHTML}
                    </div>
                </div>
                <div class="course-actions">
                    <button class="btn btn-edit" data-id="${kh.id}">S·ª≠a</button>
                    <button class="btn btn-delete" data-id="${kh.id}" data-name="${kh.ten}">X√≥a</button>
                </div>
            `;
            listKhoaHocDiv.appendChild(itemDiv);
        });
    }

    listKhoaHocDiv.addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.dataset.id;

        if (target.classList.contains('btn-delete')) {
            const name = target.dataset.name;
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√≥a h·ªçc "${name}" kh√¥ng?`)) {
                const { error } = await supabase.from("khoahoc").delete().eq("id", id);
                if (error) {
                    alert("‚ùå L·ªói khi x√≥a: " + error.message);
                } else {
                    alert("‚úÖ ƒê√£ x√≥a kh√≥a h·ªçc th√†nh c√¥ng!");
                    hienThiDanhSachKhoaHoc();
                }
            }
        }

        if (target.classList.contains('btn-edit')) {
            const { data, error } = await supabase.from("khoahoc").select("*").eq("id", id).single();
            if (error) {
                alert("L·ªói kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc ƒë·ªÉ s·ª≠a!");
                return;
            }
            
            document.getElementById("inputTen").value = data.ten;
            document.getElementById("inputmo_ta").value = data.mo_ta;
            document.getElementById("selectKhuVuc").value = data.loai;
            document.getElementById("inputHinh").value = data.hinh;
            document.getElementById("inputGiaGoc").value = data.gia_goc;
            document.getElementById("inputGia").value = data.gia;
            document.getElementById("inputRating").value = data.rating;
            document.getElementById("inputRatingCount").value = data.rating_count;
            document.getElementById("inputLuotMua").value = data.luot_mua;
            document.getElementById("inputBadge").value = data.badge;

            // ‚ú® M√É M·ªöI: ƒêi·ªÅn d·ªØ li·ªáu linkdrive v√†o form
            document.getElementById("inputLinkdrive").value = data.linkdrive;

            currentEditId = id;
            formTitle.textContent = "Ch·ªânh S·ª≠a Kh√≥a H·ªçc";
            submitBtn.textContent = "C·∫≠p Nh·∫≠t";
            cancelBtn.style.display = "inline-block";
            
            // ‚ú® M√É M·ªöI: G·ªçi h√†m ƒë·ªÉ ki·ªÉm tra v√† hi·ªán √¥ linkdrive n·∫øu c·∫ßn
            toggleLinkdriveVisibility();

            document.getElementById('course-form-section').scrollIntoView({ behavior: 'smooth' });
        }
    });

    function resetForm() {
        form.reset();
        currentEditId = null;
        formTitle.textContent = "Th√™m Kh√≥a H·ªçc M·ªõi";
        submitBtn.textContent = "Th√™m Kh√≥a H·ªçc";
        cancelBtn.style.display = "none";
        document.getElementById("selectKhuVuc").selectedIndex = 0;
        
        // ‚ú® M√É M·ªöI: ·∫®n √¥ linkdrive khi reset form
        linkdriveGroup.style.display = 'none';
    }

    cancelBtn.addEventListener('click', resetForm);

    form.addEventListener("submit", async e => {
        e.preventDefault();
        const courseData = {
            ten: document.getElementById("inputTen").value.trim(),
            mo_ta: document.getElementById("inputmo_ta").value.trim(),
            loai: document.getElementById("selectKhuVuc").value,
            hinh: document.getElementById("inputHinh").value.trim() || null,
            gia_goc: document.getElementById("inputGiaGoc").value || null,
            gia: document.getElementById("inputGia").value,
            rating: document.getElementById("inputRating").value || null,
            rating_count: document.getElementById("inputRatingCount").value || null,
            luot_mua: document.getElementById("inputLuotMua").value || null,
            badge: document.getElementById("inputBadge").value.trim() || null,

            // ‚ú® M√É M·ªöI: Th√™m linkdrive v√†o ƒë·ªëi t∆∞·ª£ng g·ª≠i ƒëi
            linkdrive: document.getElementById("inputLinkdrive").value.trim() || null
        };

        let error;
        if (currentEditId) {
            const { error: updateError } = await supabase.from("khoahoc").update(courseData).eq("id", currentEditId);
            error = updateError;
        } else {
            const { error: insertError } = await supabase.from("khoahoc").insert([courseData]);
            error = insertError;
        }

        if (error) {
            alert("‚ùå L·ªói: " + error.message);
        } else {
            alert(`‚úÖ ƒê√£ ${currentEditId ? 'c·∫≠p nh·∫≠t' : 'th√™m'} kh√≥a h·ªçc th√†nh c√¥ng!`);
            resetForm();
            hienThiDanhSachKhoaHoc();
        }
    });

    // Ch·ª©c nƒÉng c·∫≠p nh·∫≠t h√†ng lo·∫°t kh√¥ng thay ƒë·ªïi
    async function updateExistingData() {
        if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO ‚ö†Ô∏è\n\nB·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t l·∫°i to√†n b·ªô d·ªØ li·ªáu c≈© kh√¥ng? \nH√†nh ƒë·ªông n√†y s·∫Ω GHI ƒê√à gi√° g·ªëc, sao, l∆∞·ª£t mua, l∆∞·ª£t ƒë√°nh gi√° v√† nh√£n c·ªßa T·∫§T C·∫¢ c√°c kh√≥a h·ªçc hi·ªán c√≥.")) {
            return;
        }
        updateAllBtn.disabled = true;
        updateAllBtn.textContent = "ƒêang c·∫≠p nh·∫≠t...";
        const { data: courses, error } = await supabase.from("khoahoc").select("id, gia");
        if (error) {
            alert("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu ƒë·ªÉ c·∫≠p nh·∫≠t: " + error.message);
            updateAllBtn.disabled = false;
            updateAllBtn.textContent = "C·∫≠p nh·∫≠t D·ªØ li·ªáu c≈©";
            return;
        }
        if (!courses || courses.length === 0) {
            alert("Kh√¥ng c√≥ kh√≥a h·ªçc n√†o ƒë·ªÉ c·∫≠p nh·∫≠t.");
            updateAllBtn.disabled = false;
            updateAllBtn.textContent = "C·∫≠p nh·∫≠t D·ªØ li·ªáu c≈©";
            return;
        }
        let successCount = 0;
        let errorCount = 0;
        const specialBadges = ["∆Øu ƒë√£i", "B√°n ch·∫°y", "Hot", "Ph√π h·ª£p"];
        const updatePromises = courses.map(async (course) => {
            try {
                const newLuotMua = Math.floor(Math.random() * (500 - 100 + 1)) + 100;
                const maxRatingCount = newLuotMua > 1 ? newLuotMua - 1 : 1;
                const newRatingCount = Math.floor(Math.random() * (maxRatingCount - 10 + 1)) + 10;
                const newRating = (Math.random() * (5.0 - 4.2) + 4.2).toFixed(1);
                const currentPrice = course.gia;
                let newOriginalPrice = null;
                if (currentPrice && currentPrice > 0) {
                    const discountPercentage = Math.random() * (0.5 - 0.15) + 0.15;
                    const tempOriginalPrice = currentPrice / (1 - discountPercentage);
                    newOriginalPrice = Math.round(tempOriginalPrice / 10) * 10;
                }
                const newBadge = specialBadges[Math.floor(Math.random() * specialBadges.length)];
                const dataToUpdate = {
                    rating: newRating,
                    luot_mua: newLuotMua,
                    rating_count: newRatingCount,
                    gia_goc: newOriginalPrice,
                    badge: newBadge,
                };
                const { error: updateError } = await supabase.from("khoahoc").update(dataToUpdate).eq("id", course.id);
                if (updateError) {
                    console.error(`‚ùå L·ªói c·∫≠p nh·∫≠t ID ${course.id}:`, updateError.message);
                    errorCount++;
                } else {
                    successCount++;
                }
            } catch (err) {
                 console.error(`‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh v·ªõi ID ${course.id}:`, err);
                 errorCount++;
            }
        });
        await Promise.all(updatePromises);
        alert(`‚ú® Ho√†n t·∫•t! ‚ú®\n- C·∫≠p nh·∫≠t th√†nh c√¥ng: ${successCount} kh√≥a h·ªçc.\n- G·∫∑p l·ªói: ${errorCount} kh√≥a h·ªçc.`);
        updateAllBtn.disabled = false;
        updateAllBtn.textContent = "C·∫≠p nh·∫≠t D·ªØ li·ªáu c≈©";
        hienThiDanhSachKhoaHoc();
    }
    updateAllBtn.addEventListener('click', updateExistingData);

    // Kh·ªüi ch·∫°y
    taoOptionKhuVuc();
    hienThiDanhSachKhoaHoc();
</script>

</body>
</html>
